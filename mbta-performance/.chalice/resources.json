{
  "Parameters": {
    "DDApiKey": {
      "Type": "String",
      "Description": "Datadog API key."
    },
    "DDTags": {
      "Type": "String",
      "Description": "Additional Datadog Tags"
    },
    "GitVersion": {
      "Type": "String",
      "Description": "Current Git Id"
    }
  },
  "Resources": {
    "ProcessDailyLamp": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Description": "Processes today's LAMP data, regularly throughout the day",
        "Environment": {
          "Variables": {
            "DD_LAMBDA_HANDLER": "app.process_daily_lamp",
            "DD_API_KEY": {
              "Ref": "DDApiKey"
            },
            "DD_VERSION": {
              "Ref": "GitVersion"
            },
            "DD_TAGS": {
              "Ref": "DDTags"
            }
          }
        },
        "EphemeralStorage": {
          "Size": 2048
        }
      }
    },
    "ProcessYesterdayLamp": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Description": "Processes yesterday's LAMP data, once in the morning to catch any cleaned data",
        "Environment": {
          "Variables": {
            "DD_LAMBDA_HANDLER": "app.process_yesterday_lamp",
            "DD_API_KEY": {
              "Ref": "DDApiKey"
            },
            "DD_VERSION": {
              "Ref": "GitVersion"
            },
            "DD_TAGS": {
              "Ref": "DDTags"
            }
          }
        },
        "EphemeralStorage": {
          "Size": 2048
        }
      }
    },
    "EnsureGtfsBundle": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Description": "Pre-fetches and uploads the GTFS bundle for today so LAMP ingest does not time out on new bundles",
        "Environment": {
          "Variables": {
            "DD_LAMBDA_HANDLER": "app.ensure_gtfs_bundle",
            "DD_API_KEY": {
              "Ref": "DDApiKey"
            },
            "DD_VERSION": {
              "Ref": "GitVersion"
            },
            "DD_TAGS": {
              "Ref": "DDTags"
            }
          }
        },
        "EphemeralStorage": {
          "Size": 2048
        }
      }
    }
  }
}
